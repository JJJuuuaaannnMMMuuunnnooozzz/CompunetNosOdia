(()=>{"use strict";class e extends Demo.ChatClient{constructor(e){super(),console.log("ChatObserver INSTANCIADO",e),this.delegate=e}incomingCall(e,t){console.log("Observer incomingCall JS desde ICE:",e),this.delegate.onIncomingCall?(console.log("Ejecutando callback onIncomingCall"),this.delegate.onIncomingCall(e)):console.log("onIncomingCall NO está configurado")}callAccepted(e,t){console.log("Observer callAccepted JS:",e),this.delegate.onCallAccepted?(console.log("Si la aceptó"),this.delegate.onCallAccepted(e)):console.log("no aceptó :(")}receiveAudio(e,t){console.log("Observer receiveAudio JS, bytes:",e?.length),this.delegate.onAudioRecieved&&this.delegate.onAudioRecieved(e)}receiveVoiceNote(e,t,n){console.log(`Nota de voz recibida de ${e}: ${t.length} bytes`),this.delegate.onVoiceNoteReceived&&this.delegate.onVoiceNoteReceived(e,t)}incomingGroupCall(e,t,n){console.log("Observer incomingGroupCall JS desde ICE:",e,"por",t),this.delegate.onIncomingGroupCall?this.delegate.onIncomingGroupCall(e,t):console.log("onIncomingGroupCall NO está configurado")}groupCallAccepted(e,t,n){console.log("Observer groupCallAccepted JS:",e,"participante:",t),this.delegate.onGroupCallAccepted?this.delegate.onGroupCallAccepted(e,t):console.log("onGroupCallAccepted NO está configurado")}}const t=new class{constructor(){this.communicator=null,this.serverProxy=null,this.adapter=null,this.myUsername=null,this.onIncomingCall=null,this.onCallAccepted=null,this.onAudioRecieved=null,this.onIncomingGroupCall=null,this.onGroupCallAccepted=null,this.activeGroupCalls=new Map}async init(t){this.myUsername=t;let n="localhost";try{const e=await fetch("./config.json"),t=await e.json();t.serverIp&&(n=t.serverIp,console.log("Configuracion cargada desde config.json ",n))}catch(e){console.warn("No se cargo config.json, usando localhost")}this.communicator=Ice.initialize();const o=`ChatServer:ws -h ${n} -p 9099`,a=this.communicator.stringToProxy(o);this.serverProxy=await Demo.ChatServerPrx.checkedCast(a),this.adapter=await this.communicator.createObjectAdapter(""),console.log("Adapter creado:",this.adapter);const r=await this.serverProxy.ice_getConnection();console.log("Conexión ICE obtenida (real):",r),r.setAdapter(this.adapter),console.log("Adapter asociado a la conexión"),console.log("Antes de instanciar ChatObserver");const s=new e(this);console.log("Después de instanciar ChatObserver");const i=await this.adapter.addWithUUID(s),l=Demo.ChatClientPrx.uncheckedCast(i);console.log("Antes de register"),await this.serverProxy.register(t,l),console.log("Después de register"),await this.adapter.activate(),console.log(`Conectado a ICE como ${t}`)}async callUser(e){this.serverProxy&&await this.serverProxy.initiateCall(this.myUsername,e)}async answerCall(e){await this.serverProxy.answerCall(this.myUsername,e)}async sendAudioChunck(e,t){console.log("Enviando audio a",e,"bytes:",t?.length),await this.serverProxy.sendAudio(this.myUsername,e,t)}async sendVoiceNote(e,t){this.serverProxy?(console.log("Enviando archivo de audio a",e,"bytes:",t?.length),await this.serverProxy.sendVoiceNote(this.myUsername,e,t)):console.error("No conectado al servidor ICE")}async sendGroupVoiceNote(e,t){this.serverProxy&&(console.log(`Enviando nota de voz a grupo ${e}`),await this.serverProxy.sendGroupVoiceNote(this.myUsername,e,t))}async callGroup(e){this.serverProxy&&await this.serverProxy.initiateGroupCall(this.myUsername,e)}async answerGroupCall(e){this.serverProxy&&await this.serverProxy.answerGroupCall(this.myUsername,e)}async sendGroupAudio(e,t){console.log("Enviando audio grupal a",e,"bytes:",t?.length),await this.serverProxy.sendGroupAudio(this.myUsername,e,t)}};let n=null,o=[],a=!1,r=null,s=null;const i=()=>{n||(n=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100}))},l=()=>{if(0===o.length)return void(a=!1);a=!0;const e=o.shift(),t=n.createBuffer(1,e.length,44100);t.getChannelData(0).set(e);const r=n.createBufferSource();r.buffer=t,r.connect(n.destination),r.start(),r.onended=l},c=async(e,o=!1)=>{i();try{r=await navigator.mediaDevices.getUserMedia({audio:!0});const a=n.createMediaStreamSource(r);s=n.createScriptProcessor(2048,1,1),s.onaudioprocess=n=>{const a=n.inputBuffer.getChannelData(0),r=new ArrayBuffer(2*a.length),s=new DataView(r);for(let e=0;e<a.length;e++){let t=Math.max(-1,Math.min(1,a[e]));s.setInt16(2*e,t<0?32768*t:32767*t,!0)}const i=new Uint8Array(r);o?t.sendGroupAudio(e,i):t.sendAudioChunck(e,i)},a.connect(s),s.connect(n.destination)}catch(e){console.error("Error al acceder al micrófono:",e),alert("No se pudo acceder al micrófono.")}};let d,u=[];function p({chatId:e}={}){const n=document.createElement("div"),p=window.location.hostname,m=new WebSocket(`ws://${p}:3002`);m.onopen=()=>console.log("Conectado al WebSocket del proxy."),m.onmessage=e=>{try{const t=JSON.parse(e.data),o=n.querySelector("#receivedMessages"),a=document.createElement("div");if("GET_MESSAGE"===t.command){const e=t.data||{},n=e.sender||"Desconocido",r=e.message;a.className="ws-item",a.innerHTML=`<span class="tag">Privado</span> <strong>${n}:</strong> ${r}`,o?.prepend(a)}else if("GET_MSG_GROUP"===t.command){const e=t.data||{},n=e.group||e.groupName||"Grupo",r=e.sender||"Desconocido",s=e.message;a.className="ws-item",a.innerHTML=`<span class="tag tag-group">${n}</span> <strong>${r}:</strong> ${s}`,o?.prepend(a)}else a.className="ws-item muted",a.textContent=JSON.stringify(t),o?.prepend(a)}catch(e){console.error("Error al parsear JSON del proxy:",e)}},n.innerHTML=`\n    \x3c!-- Login  --\x3e\n    <div id="loginOverlay" class="login-screen">\n        <div class="login-card">\n            <h2>Bienvenido al Chat</h2>\n            <p>Ingresa tu usuario para conectar a ICE y Proxy</p>\n            <form id="loginForm" class="form">\n                <input type="text" id="loginUsername" placeholder="Nombre de usuario" required />\n                <input type="text" id="loginIp" placeholder="IP del Servidor (opcional)" />\n                <button type="submit">Conectar</button>\n            </form>\n        </div>\n    </div>\n\n    \x3c!--main (Oculto inicialmente) --\x3e\n    <div id="mainLayout" class="layout hidden">\n        <div class="sidebar">\n            <div class="side-header">\n                <div class="avatar"></div>\n                <div>\n                    <div class="me" id="displayUsername">Cliente HTTP</div>\n                    <small style="color:var(--accent)">● Conectado</small>\n                </div>\n            </div>\n            \n            \x3c!-- notitas de voz--\x3e\n            <div class="side-card">\n                <h3 class="side-title">Notas de voz</h3>\n                <p class="side-subtitle">Graba y envía audio por ICE</p>\n                \n                <div class="segmented">\n                    <label class="seg active">\n                        <input id="audioModeUser" type="radio" name="audioMode" checked>\n                        <span>Usuario</span>\n                    </label>\n                    <label class="seg">\n                        <input id="audioModeGroup" type="radio" name="audioMode">\n                        <span>Grupo</span>\n                    </label>\n                </div>\n\n                <input id="vnDestInput" class="input" type="text" placeholder="Usuario Destino">\n\n                <div class="row">\n                    <button id="audioOpenMicButton" type="button" class="btn">Grabar</button>\n                    <button id="audioStopButton" type="button" class="btn ghost" disabled>Detener</button>\n                </div>\n\n                <button id="audioSendButton" type="button" class="btn" disabled>Enviar nota</button>\n                <div id="audioStatus" class="muted" style="margin-top:5px; font-size:0.8em;"></div>\n            </div>\n            \n            \x3c!-- las llamadas van por aqui --\x3e\n            <div class="side-card">\n                <h3 class="side-title">Llamadas</h3>\n                <p class="side-subtitle">Inicia/termina llamadas a usuario o grupo</p>\n\n                <div class="segmented">\n                    <label class="seg active">\n                        <input id="callModeUser" type="radio" name="callMode" checked>\n                        <span>Usuario</span>\n                    </label>\n                    <label class="seg">\n                        <input id="callModeGroup" type="radio" name="callMode">\n                        <span>Grupo</span>\n                    </label>\n                </div>\n\n                <input id="targetInputCall" class="input" type="text" placeholder="Destino (usuario o grupo)">\n\n                <div class="row">\n                    <button id="callButton" type="button" class="btn">Llamar</button>\n                    <button id="hangUpButton" type="button" class="btn ghost">Colgar</button>\n                </div>\n            </div>\n\n            <div id="chatList" class="chat-list"></div>\n        </div>\n\n        <div class="main">\n            <header class="main-header">\n                <div>\n                    <h1>Proxy Chat (HTTP)</h1>\n                    <p class="muted">Crea grupos, envía mensajes y consulta historial vía proxy Express → backend Java (TCP)</p>\n                </div>\n                ${e?`<div class="pill">Chat seleccionado: <strong>${e}</strong></div>`:""}\n            </header>\n\n            <div class="panels">\n                <section class="panel">\n                    <h2>Usuario y Chat Privado</h2>\n\n                    \x3c!-- formulario de registro escondido (Necesario para la lógica interna) --\x3e\n                    <form id="registerForm" class="form hidden">\n                        <h3>1. Registrar Usuario</h3>\n                        <input type="text" id="username" placeholder="Usuario" required />\n                        <input type="text" id="clientIp" placeholder="IP del cliente (opcional)" />\n                        <button type="submit">Registrar</button>\n                    </form>\n\n                    <form id="chatForm" class="form">\n                        <h3>2. Enviar Mensaje Privado</h3>\n                        \x3c!-- Sender ahora oculto, se llena solo --\x3e\n                        <input type="hidden" id="sender" />\n                        <input type="text" id="receiver" placeholder="Receptor" required />\n                        <input type="text" id="message" placeholder="Mensaje" required />\n                        <button type="submit">Enviar Privado</button>\n                    </form>\n\n                    <form id="historyForm" class="form">\n                        <h3>3. Historial Privado</h3>\n                        <p>Se consultará automáticamente el historial del usuario loggeado.</p>\n                        <button type="submit" class="ghost">Consultar Historial</button>\n                    </form>\n                </section>\n\n                <section class="panel">\n                    <h2>Funcionalidades de Grupo</h2>\n\n                    <form id="createGroupForm" class="form">\n                        <h3>3. Crear Grupo</h3>\n                        <input type="text" id="groupName" placeholder="Nombre del grupo" required />\n                        <button type="submit">Crear Grupo</button>\n                    </form>\n\n                    <form id="addToGroupForm" class="form">\n                        <h3>4. Añadir a Grupo</h3>\n                        <input type="text" id="groupNameAdd" placeholder="Nombre del grupo" required />\n                        <input type="text" id="memberToAdd" placeholder="Usuario a añadir" required />\n                        <button type="submit">Añadir Miembros</button>\n                    </form>\n\n                    <form id="groupMessageForm" class="form">\n                        <h3>5. Enviar Mensaje a Grupo</h3>\n                        <input type="text" id="groupNameMsg" placeholder="Nombre del grupo" required />\n                        <input type="text" id="groupMessage" placeholder="Mensaje" required />\n                        <button type="submit">Enviar a Grupo</button>\n                    </form>\n                </section>\n            </div>\n\n            <section class="results" style="grid-template-columns: 1fr;">\n                <div class="result-box">\n                    <h3>Mensajes recibidos (WebSocket)</h3>\n                    <div id="receivedMessages" class="ws-box"></div>\n                </div>\n            </section>\n\n            <div id="historyModal" class="modal hidden">\n                <div class="modal-content">\n                    <span id="closeModal" class="close">&times;</span>\n                    <h2>Historial completo</h2>\n                    <pre id="modalContent"></pre>\n                </div>\n            </div>\n\n            <pre id="responseBox" style="display:none"></pre>\n        </div>\n    </div>\n  `;const g=n.querySelector("#loginForm"),h=n.querySelector("#loginOverlay"),v=n.querySelector("#mainLayout"),y=n.querySelector("#loginUsername"),b=n.querySelector("#loginIp"),C=n.querySelector("#displayUsername"),f=n.querySelector("#sender"),S=localStorage.getItem("chat_username");S&&(y.value=S),fetch("./config.json").then(e=>e.json()).then(e=>{e.serverIp&&(b.value=e.serverIp)}).catch(()=>{const e=new URLSearchParams(window.location.search);e.get("ip")&&(b.value=e.get("ip"))}),g.addEventListener("submit",async e=>{e.preventDefault();const r=y.value.trim(),s=b.value.trim();if(r){if(localStorage.setItem("chat_username",r),window.loggedUser=r,h.classList.add("hidden"),v.classList.remove("hidden"),C.textContent=r,f&&(f.value=r),n.querySelector("#username").value=r,n.querySelector("#clientIp").value=s,s){const e=new URL(window.location);e.searchParams.set("serverIp",s),window.history.replaceState({},"",e)}D(`http://${p}:3001/users`,{username:r,clientIp:s},"POST","Registro exitoso:");try{await t.init(r),console.log("ICE Inicializado correctamente"),t.onAudioRecieved=e=>{(e=>{if(!e||0===e.length)return;i();const t=((e,t=!1)=>{const n=e instanceof ArrayBuffer?e:e.buffer,o=new DataView(n),a=new Float32Array(e.byteLength/2);for(let e=0;e<a.length;e++){const n=o.getInt16(2*e,t);a[e]=n/32768}return a})(new Uint8Array(e).buffer,!0);o.push(t),a||l()})(e)},t.onIncomingCall=e=>{confirm(`Llamada entrante de ${e}. ¿Contestar?`)&&(t.answerCall(e),$=e,P=!1,c(e,!1))},t.onCallAccepted=e=>{alert(`Conexión establecida con ${e}`),$=e,P=!1,c(e,!1)},t.onIncomingGroupCall=(e,n)=>{confirm(`Llamada grupal entrante del grupo "${e}" iniciada por ${n}. ¿Unirse?`)&&(t.answerGroupCall(e),$=e,P=!0,c(e,!0))},t.onGroupCallAccepted=(e,t)=>{console.log(`Usuario ${t} se unió a la llamada grupal ${e}`),$===e&&console.log(`Nuevo participante: ${t}`)},t.onVoiceNoteReceived=(e,t)=>{const o=new Blob([t],{type:"audio/webm"}),a=URL.createObjectURL(o);let r=e,s="Audio ICE",i="background:#e91e63;";if(e.includes(":")){const t=e.split(":"),n=t[0];r=`${t[1]}`,s=`${n}`,i="background:#2196f3;"}const l=n.querySelector("#receivedMessages"),c=document.createElement("div");c.className="ws-item",c.innerHTML=`\n            <span class="tag" style="${i}">${s}</span>\n            <strong>${r}:</strong>\n            <br>\n            <audio controls src="${a}" style="margin-top:5px; width:100%;"></audio>\n            `,l?.prepend(c)}}catch(e){console.error("Error ICE:",e)}}});const w=n.querySelector("#audioOpenMicButton"),x=n.querySelector("#audioStopButton"),E=n.querySelector("#audioSendButton"),A=n.querySelector("#vnDestInput"),q=n.querySelector("#audioStatus"),G=n.querySelector("#callButton"),M=n.querySelector("#hangUpButton"),I=n.querySelector("#targetInputCall"),N=n.querySelectorAll('input[name="callMode"]');let $=null,P=!1,U=null;G.addEventListener("click",async()=>{const e=I.value.trim();if(!e)return alert("Escribe un usuario o grupo destino");const n="Grupo"===Array.from(N).find(e=>e.checked)?.nextElementSibling?.textContent;try{n?(await t.callGroup(e),console.log("Llamando a grupo...",e),$=e,P=!0,c(e,!0)):(await t.callUser(e),console.log("Llamando a...",e),$=e,P=!1)}catch(e){console.error("Error al llamar:",e),alert("Error al iniciar la llamada: "+e.message)}}),M.addEventListener("click",()=>{console.log("Colgando llamada..."),console.log("Deteniendo micrófono..."),r&&(r.getTracks().forEach(e=>{e.stop(),console.log("Track detenido:",e.kind)}),r=null),s&&(s.onaudioprocess=null,s.disconnect(),s=null),$=null,P=!1,console.log("Llamada terminada")}),w.addEventListener("click",async()=>{await async function(){try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});return d=new MediaRecorder(e),u=[],d.ondataavailable=e=>{u.push(e.data)},d.start(),!0}catch(e){return console.error("Error micrófono:",e),!1}}()&&(w.disabled=!0,w.textContent="Grabando...",x.disabled=!1,E.disabled=!0,q.textContent="Grabando...")}),x.addEventListener("click",async()=>{U=await new Promise(e=>{if(!d)return e(new Uint8Array(0));d.onstop=async()=>{const t=new Blob(u,{type:"audio/webm"}),n=await t.arrayBuffer(),o=new Uint8Array(n);d.stream.getTracks().forEach(e=>e.stop()),e(o)},d.stop()}),w.disabled=!1,w.textContent="Grabar",x.disabled=!0,E.disabled=!1,q.textContent=`Audio listo (${U.length} bytes)`}),E.addEventListener("click",()=>{const e=A.value.trim();return e?U?(n.querySelector("#audioModeGroup").checked?t.sendGroupVoiceNote(e,U):t.sendVoiceNote(e,U),U=null,E.disabled=!0,void(q.textContent="Enviado.")):alert("No hay audio grabado"):alert("Pon un usuario destino para el audio")});const L=n.querySelector("#chatList"),T=e=>{const t=n.querySelectorAll(`input[name="${e}"]`);t.forEach(e=>{e.addEventListener("change",e=>{t.forEach(e=>e.closest(".seg")?.classList.remove("active")),e.target.checked&&e.target.closest(".seg")?.classList.add("active")})})};T("audioMode"),T("callMode");try{if(function(e,t){t.forEach(t=>{const n=function(e){const t=document.createElement("div");return t.className="chat-item",t.innerHTML=`\n    <h4>${e.name}</h4>\n    <p>${e.lastMessage}</p>\n  `,t.addEventListener("click",()=>{window.location.hash=`#chat/${e.id}`}),t}(t);e.appendChild(n)})}(L,[{id:"ana",name:"Ana",lastMessage:"¿Listo para la demo?"},{id:"equipo",name:"Equipo SID2",lastMessage:"Reunión 7pm"}]),e){const t=n.querySelector("#receiver"),o=n.querySelector("#groupNameMsg");t&&(t.value=e),o&&(o.value=e)}}catch(e){console.warn("No se pudo renderizar la lista (omitido):",e)}const O=n.querySelector("#responseBox"),D=async(e,t,o="POST",a)=>{O&&(O.textContent="Cargando...");try{const r={method:o,headers:{"Content-Type":"application/json"}};"GET"!==o&&(r.body=JSON.stringify(t));const s=await fetch(e,r),i=await s.text();let l;try{l=JSON.parse(i)}catch{l=i}if(e.includes("/history")&&"GET"===o){const e=n.querySelector("#historyModal"),t=n.querySelector("#modalContent");if(l?.data?.length){const e=l.data.map(e=>{const t=e.from||"Desconocido",n=e.to||"Desconocido",o=e.content||"";return`${t} → ${n} [${e.type||"text"}]: ${o}`}).join("\n");t.textContent=`Historial (${l.data.length} mensajes):\n\n${e}`}else t.textContent="No hay mensajes en el historial.";e.classList.remove("hidden")}else O?O.textContent=`[STATUS: ${s.status}] ${"string"==typeof l?l:JSON.stringify(l,null,2)}`:console.log("[RESPUESTA HTTP]",s.status,l);console.log(a,l)}catch(e){O&&(O.textContent="Error: "+e.message),console.error("Error en la petición:",e)}};n.querySelector("#chatForm").addEventListener("submit",e=>{e.preventDefault();const t=n.querySelector("#sender").value,o=n.querySelector("#receiver").value,a=n.querySelector("#message").value;D(`http://${p}:3001/messages`,{sender:t,receiver:o,message:a},"POST","Mensaje privado enviado:"),n.querySelector("#message").value=""}),n.querySelector("#historyForm").addEventListener("submit",e=>{if(e.preventDefault(),!window.loggedUser)return alert("Primero registre un usuario.");D(`http://${p}:3001/users/${window.loggedUser}/history`,null,"GET","Historial cargado:")}),n.querySelector("#createGroupForm").addEventListener("submit",e=>{e.preventDefault();const t=n.querySelector("#groupName").value;D(`http://${p}:3001/groups`,{groupName:t},"POST","Grupo creado:")}),n.querySelector("#addToGroupForm").addEventListener("submit",e=>{e.preventDefault();const t=n.querySelector("#groupNameAdd").value,o=n.querySelector("#memberToAdd").value;D(`http://${p}:3001/groups/${t}/members`,{members:[o]},"POST","Miembro añadido al grupo:")}),n.querySelector("#groupMessageForm").addEventListener("submit",e=>{e.preventDefault();const t=n.querySelector("#groupMessage").value,o=n.querySelector("#groupNameMsg").value;D(`http://${p}:3001/groups/${o}/messages`,{message:t},"POST","Mensaje de grupo enviado:")});const k=n.querySelector("#historyModal");return n.querySelector("#closeModal").addEventListener("click",()=>k.classList.add("hidden")),k.addEventListener("click",e=>{e.target===k&&k.classList.add("hidden")}),n}const m=({"/":p,"/Chat/index.html":p,"/Chat/":p}[window.location.pathname]||(()=>{const e=document.createElement("p");return e.innerText="404 - Not Found",e}))(),g=document.getElementById("app");g.innerHTML="",g.appendChild(m)})();